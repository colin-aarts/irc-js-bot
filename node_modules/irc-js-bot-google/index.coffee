
#	irc-bot-js-google
#	-----------------
#	Google search for irc-js-bot
#	This is an official plug-in
#
#	Provides one bot command: 'g'
#	Depends on the 'goo.gl' module

'use strict'


util    = require 'util'
http    = require 'http'
shorten = require 'goo.gl'


module.exports = ->

	@register_special_command
		name: 'g'
		description: 'Perform a web search using Google.'
		admin_only: false
		fn: (event, input_data, output_data) =>

			await search input_data.args, defer err, response

			results = response.responseData.results

			if err
				message = 'Oops, something went wrong!'
			else if not results[0]
				message = "No results for query '#{input_data.args}'"
			else if results
				await shorten response.responseData.cursor.moreResultsUrl, defer shorten_err, results_uri
				message = """Google says "#{results[0].titleNoFormatting}" • #{results[0].unescapedUrl} • More results: #{results_uri}"""

			@send output_data.method, output_data.recipient, message


search = (query, cb) ->

	query += ' -site:w3schools.com -site:tizag.com'
	result = []

	req = http.request
		hostname: 'ajax.googleapis.com'
		path: "/ajax/services/search/web?v=1.0&q=#{encodeURIComponent query}"
		method: 'get'
	, (res) ->
		res.setEncoding 'utf-8'
		res.on 'data', (data) ->
			result.push data
		res.on 'end', ->
			result = result.join ''
			result = JSON.parse result

			err = true if not result

			cb err, result

	req.on 'error', (err) ->
		cb err, null

	do req.end
